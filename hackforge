#!/bin/bash

# Hackforge Control Script
# Central command for all Hackforge operations

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_banner() {
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ                      HACKFORGE                            โ"
    echo "โ          Dynamic Vulnerability Training Platform          โ"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
}

show_usage() {
    show_banner
    echo "Usage: ./hackforge <command>"
    echo ""
    echo "Commands:"
    echo ""
    echo "  ๐ฆ GENERATION"
    echo "    generate         Generate new vulnerable machines"
    echo "    template         Convert configs to applications"
    echo ""
    echo "  ๐ณ DOCKER OPERATIONS"
    echo "    start            Build and start all machines"
    echo "    stop             Stop all running machines"
    echo "    restart          Restart all machines"
    echo "    destroy          Remove all containers"
    echo "    status           Show machine status"
    echo "    logs             Show logs (add -f to follow)"
    echo "    build            Build images only"
    echo ""
    echo "  ๐ INFORMATION"
    echo "    list             List all available machines"
    echo "    info             Show project information"
    echo ""
    echo "  ๐งน CLEANUP"
    echo "    clean            Clean generated files"
    echo "    reset            Full reset (careful!)"
    echo ""
    echo "Examples:"
    echo "  ./hackforge generate       # Generate new machines"
    echo "  ./hackforge start          # Start all machines"
    echo "  ./hackforge status         # Check running machines"
    echo "  ./hackforge logs -f        # Follow logs"
    echo ""
}

case "$1" in
    generate)
        show_banner
        echo "๐ฒ Generating vulnerable machines..."
        cd "$SCRIPT_DIR/core"
        python3 generator.py
        ;;
    
    template)
        show_banner
        echo "๐จ Converting configs to applications..."
        cd "$SCRIPT_DIR/core"
        python3 template_engine.py
        ;;
    
    start|stop|restart|destroy|status|logs|build)
        cd "$SCRIPT_DIR/docker/orchestrator"
        python3 orchestrator.py "$@"
        ;;
    
    list)
        cd "$SCRIPT_DIR/docker/orchestrator"
        python3 orchestrator.py list
        ;;
    
    info)
        show_banner
        echo "๐ Project Location: $SCRIPT_DIR"
        echo ""
        echo "๐ Directory Structure:"
        echo "  core/               - Blueprint and generation engine"
        echo "  docker/             - Container orchestration"
        echo "  web/                - Web API and frontend"
        echo "  cli/                - Command-line tools"
        echo ""
        echo "๐ง Components Status:"
        
        if [ -d "$SCRIPT_DIR/core/generated_machines" ]; then
            machine_count=$(find "$SCRIPT_DIR/core/generated_machines" -name "config.json" | wc -l)
            echo "  โ Generated machines: $machine_count"
        else
            echo "  โ No machines generated yet"
        fi
        
        if command -v docker &> /dev/null; then
            echo "  โ Docker installed"
        else
            echo "  โ Docker not found"
        fi
        
        if command -v docker-compose &> /dev/null; then
            echo "  โ Docker Compose installed"
        else
            echo "  โ Docker Compose not found"
        fi
        
        echo ""
        ;;
    
    clean)
        show_banner
        echo "๐งน Cleaning generated files..."
        
        read -p "Remove generated machines? (y/n): " confirm
        if [ "$confirm" = "y" ]; then
            rm -rf "$SCRIPT_DIR/core/generated_machines"
            echo "โ Cleaned generated_machines/"
        fi
        
        read -p "Remove campaigns? (y/n): " confirm
        if [ "$confirm" = "y" ]; then
            rm -rf "$SCRIPT_DIR/core/campaigns"
            echo "โ Cleaned campaigns/"
        fi
        
        echo "โ Cleanup complete"
        ;;
    
    reset)
        show_banner
        echo "โ๏ธ  WARNING: This will:"
        echo "  - Stop and remove all containers"
        echo "  - Delete all generated machines"
        echo "  - Delete all campaigns"
        echo ""
        read -p "Are you SURE? Type 'RESET' to confirm: " confirm
        
        if [ "$confirm" = "RESET" ]; then
            echo ""
            echo "Stopping containers..."
            cd "$SCRIPT_DIR/docker/orchestrator"
            python3 orchestrator.py destroy 2>/dev/null
            
            echo "Removing generated files..."
            rm -rf "$SCRIPT_DIR/core/generated_machines"
            rm -rf "$SCRIPT_DIR/core/campaigns"
            
            echo ""
            echo "โ Full reset complete!"
            echo "Run './hackforge generate' to start fresh"
        else
            echo "Cancelled"
        fi
        ;;
    
    *)
        show_usage
        exit 0
        ;;
esac
